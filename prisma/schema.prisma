// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id            String         @id @default(cuid())
  name          String
  baseCurrency  String         @default("EUR")
  createdAt     DateTime       @default(now())
  users         User[]
  stores        Store[]
  items         Item[]
  categories    Category[]
  stockEntries  StockEntry[]
  stockCounts   StockCount[]
  roles         Role[]
}

model Role {
  id           String   @id @default(cuid())
  name         String
  permissions  String   // JSON string of permissions array
  accountId    String
  account      Account  @relation(fields: [accountId], references: [id])
  isSystemRole Boolean  @default(false)
  users        User[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  image       String?
  accountId   String
  account     Account      @relation(fields: [accountId], references: [id])
  roleId      String?
  role        Role?        @relation(fields: [roleId], references: [id])
  stockCounts StockCount[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Store {
  id           String       @id @default(cuid())
  name         String
  address      String?
  accountId    String
  account      Account      @relation(fields: [accountId], references: [id])
  stockEntries StockEntry[]
  stockCounts  StockCount[]
  createdAt    DateTime     @default(now())
}

// Reusable Item Master (like a product catalog)
model Item {
  id           String       @id @default(cuid())
  name         String
  description  String?
  unit         String       // kg, L, pieces, etc.
  categoryId   String?
  category     Category?    @relation(fields: [categoryId], references: [id])
  accountId    String
  account      Account      @relation(fields: [accountId], references: [id])
  stockEntries StockEntry[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

// Reusable Categories
model Category {
  id        String   @id @default(cuid())
  name      String
  parentId  String?
  parent    Category? @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  Category[] @relation("CategoryToCategory")
  accountId String
  account   Account  @relation(fields: [accountId], references: [id])
  items     Item[]
  createdAt DateTime @default(now())
}

// Actual Stock Entries (quantity + cost per store)
model StockEntry {
  id           String      @id @default(cuid())
  itemId       String
  item         Item        @relation(fields: [itemId], references: [id])
  storeId      String
  store        Store       @relation(fields: [storeId], references: [id])
  quantity     Float
  unitCost     Float?      // Optional cost
  currency     String      @default("EUR")
  accountId    String
  account      Account     @relation(fields: [accountId], references: [id])
  notes        String?
  stockCountId String?     // Link to count session if created during a count
  stockCount   StockCount? @relation(fields: [stockCountId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

// Stock Count Session - groups multiple stock entries from a single count
model StockCount {
  id           String       @id @default(cuid())
  name         String?      // Optional name like "Weekly Count - Week 3"
  storeId      String
  store        Store        @relation(fields: [storeId], references: [id])
  userId       String       // Who performed the count
  user         User         @relation(fields: [userId], references: [id])
  accountId    String
  account      Account      @relation(fields: [accountId], references: [id])
  status       String       @default("in_progress") // in_progress, completed, cancelled
  entries      StockEntry[]
  totalValue   Float?       // Calculated total value of count
  itemsCounted Int          @default(0)
  notes        String?
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}
